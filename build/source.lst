# file opened: src/main.asm
  1   0000                              device zxspectrum48
  2   0000
  3   0000                              org 8000h
  4   8000
  5   8000              Start:
  6   8000 3E 06        1               ld a, 0b110
  7   8002 D3 FE                        out (254), a
  8   8004
  9   8004 11 2D 80                     ld de, InterruptRoutine
 10   8007 CD D6 83                     call im2.Setup
 11   800A
 12   800A
 13   800A 21 00 40                     ld hl, 0x4000
 14   800D 11 C0 16                     ld de, 182 * 32
 15   8010 AF                           xor a
 16   8011              .loop
 17   8011 77                           ld (hl), a
 18   8012 23                           inc hl
 19   8013 1B                           dec de
 20   8014
 21   8014 15                           dec d
 22   8015 14                           inc d
 23   8016 20 F9                        jr nz, .loop
 24   8018
 25   8018 1D                           dec e
 26   8019 1C                           inc e
 27   801A 20 F5                        jr nz, .loop
 28   801C
 29   801C 06 40                        ld b, 64
 30   801E 0E 0F                        ld c, 15
 31   8020
 32   8020              aga:
 33   8020                              ;ld hl, isaac_x
 34   8020                              ;inc (hl)
 35   8020
 36   8020                              ;inc c
 37   8020 3A 66 80                     ld a, (isaac_x)
 38   8023 4F                           ld c, a
 39   8024 3A 67 80                     ld a, (isaac_y)
 40   8027 47                           ld b, a
 41   8028 CD 8D 80                     call Isaac
 42   802B
 43   802B 18 F3                        jr aga
 44   802D
 45   802D
 46   802D              InterruptRoutine:
 47   802D E5                           push hl
 48   802E D5                           push de
 49   802F C5                           push bc
 50   8030 F5                           push af
 51   8031 DD E5                        push ix
 52   8033 FD E5                        push iy
 53   8035
 54   8035 CD A8 83                     call keyboard.Read
 55   8038 3A C7 83                     ld a, (keyboard.movement)
 56   803B CB 47                        bit keyboard.BIT_UP, a
 57   803D 28 04                        jr z, no_up
 58   803F
 59   803F 21 67 80                     ld hl, isaac_y
 60   8042 35                           dec (hl)
 61   8043              no_up:
 62   8043 CB 57                        bit keyboard.BIT_DOWN, a
 63   8045 28 04                        jr z, no_down
 64   8047
 65   8047 21 67 80                     ld hl, isaac_y
 66   804A 34                           inc (hl)
 67   804B              no_down:
 68   804B CB 4F                        bit keyboard.BIT_LEFT, a
 69   804D 28 04                        jr z, no_left
 70   804F
 71   804F 21 66 80                     ld hl, isaac_x
 72   8052 35                           dec (hl)
 73   8053              no_left:
 74   8053 CB 5F                        bit keyboard.BIT_RIGHT, a
 75   8055 28 04                        jr z, no_right
 76   8057
 77   8057 21 66 80                     ld hl, isaac_x
 78   805A 34                           inc (hl)
 79   805B              no_right:
 80   805B
 81   805B FD E1                        pop iy
 82   805D DD E1                        pop ix
 83   805F F1                           pop af
 84   8060 C1                           pop bc
 85   8061 D1                           pop de
 86   8062 E1                           pop hl
 87   8063
 88   8063 FB                           ei
 89   8064 ED 4D                        reti
 90   8066 28           isaac_x db 40
 91   8067 28           isaac_y db 40
 92   8068
 93   8068
 94   8068                              include "sprites.asm"
# file opened: src/sprites.asm
  1+  8068                    include "utils.asm"
# file opened: src/utils.asm
  1++ 8068              LineInc_DE      macro
  2++ 8068 ~
  3++ 8068 ~                            ; move down a pixel line
  4++ 8068 ~                            ; H 0-1-0-y7-y6-y2-y1-y0 l y5-y4-y3-x4-x3-x2-x1-x0
  5++ 8068 ~
  6++ 8068 ~                            inc d
  7++ 8068 ~                            ld a, d
  8++ 8068 ~                            and 7
  9++ 8068 ~                            jr nz, .q
 10++ 8068 ~                            ld a, e
 11++ 8068 ~                            add a, 32
 12++ 8068 ~                            ld e, a
 13++ 8068 ~                            jr c, .q
 14++ 8068 ~                            ld a, d
 15++ 8068 ~                            sub 8
 16++ 8068 ~                            ld d, a
 17++ 8068 ~            .q:
 18++ 8068 ~
 19++ 8068                              endm
 20++ 8068
 21++ 8068
 22++ 8068
 23++ 8068              ; vim: set sw=16 :
 24++ 8068
# file closed: src/utils.asm
  2+  8068
  3+  8068                              include "sprite-isaac.asm"
# file opened: src/sprite-isaac.asm
  1++ 8068              head_c1:
  2++ 8068 FF                           db 0b11111111
  3++ 8069 FF                           db 0b11111111
  4++ 806A FC                           db 0b11111100
  5++ 806B F0                           db 0b11110000
  6++ 806C E0                           db 0b11100000
  7++ 806D C0                           db 0b11000000
  8++ 806E C0                           db 0b11000000
  9++ 806F 98                           db 0b10011000
 10++ 8070
 11++ 8070 B4                           db 0b10110100
 12++ 8071 BC                           db 0b10111100
 13++ 8072 98                           db 0b10011000
 14++ 8073 C3                           db 0b11000011
 15++ 8074 C2                           db 0b11000010
 16++ 8075 E1                           db 0b11100001
 17++ 8076 F0                           db 0b11110000
 18++ 8077 FC                           db 0b11111100
 19++ 8078
 20++ 8078              head_c2:
 21++ 8078 FF                           db 0b11111111
 22++ 8079 FF                           db 0b11111111
 23++ 807A 3F                           db 0b00111111
 24++ 807B 0F                           db 0b00001111
 25++ 807C 07                           db 0b00000111
 26++ 807D 03                           db 0b00000011
 27++ 807E 03                           db 0b00000011
 28++ 807F 19                           db 0b00011001
 29++ 8080
 30++ 8080 35                           db 0b00110101
 31++ 8081 3D                           db 0b00111101
 32++ 8082 19                           db 0b00011001
 33++ 8083 C3                           db 0b11000011
 34++ 8084 43                           db 0b01000011
 35++ 8085 87                           db 0b10000111
 36++ 8086 0F                           db 0b00001111
 37++ 8087 3F                           db 0b00111111
 38++ 8088
 39++ 8088              body:
 40++ 8088 3C                           db 0b00111100
 41++ 8089 A1                           db 0b10100001
 42++ 808A A1                           db 0b10100001
 43++ 808B CB                           db 0b11001011
 44++ 808C CB                           db 0b11001011
 45++ 808D
 46++ 808D              ; vim: set sw=16 ts=16 :
 47++ 808D
# file closed: src/sprite-isaac.asm
  4+  808D              Isaac:
  5+  808D                              ; BC: x, y; base of the legs
  6+  808D
  7+  808D C5                           push bc
  8+  808E 79                           ld a, c
  9+  808F D6 08                        sub 8
 10+  8091 4F                           ld c, a
 11+  8092 78                           ld a, b
 12+  8093 D6 15                        sub 21
 13+  8095 47                           ld b, a
 14+  8096 CD C5 80                     call xy_to_pos
 15+  8099 4F                           ld c, a
 16+  809A EB                           ex hl, de
 17+  809B
 18+  809B D5                           push de
 19+  809C
 20+  809C 21 68 80                     ld hl, head_c1
 21+  809F 06 10                        ld b, 16
 22+  80A1 CD DF 80                     call sprite_1ch
 23+  80A4
 24+  80A4 D1                           pop de
 25+  80A5 13                           inc de
 26+  80A6
 27+  80A6 21 78 80                     ld hl, head_c2
 28+  80A9 06 10                        ld b, 16
 29+  80AB CD E5 80                     call again
 30+  80AE
 31+  80AE C1                           pop bc
 32+  80AF 79                           ld a, c
 33+  80B0 D6 04                        sub 4
 34+  80B2 4F                           ld c, a
 35+  80B3 78                           ld a, b
 36+  80B4 D6 05                        sub 5
 37+  80B6 47                           ld b, a
 38+  80B7 CD C5 80                     call xy_to_pos
 39+  80BA 4F                           ld c, a
 40+  80BB EB                           ex hl, de
 41+  80BC
 42+  80BC 21 88 80                     ld hl, body
 43+  80BF 06 05                        ld b, 5
 44+  80C1 CD DF 80                     call sprite_1ch
 45+  80C4
 46+  80C4 C9                           ret
 47+  80C5
 48+  80C5
 49+  80C5              xy_to_pos:      ; b = y (0..191)
 50+  80C5                              ; c = x (0..255)
 51+  80C5                              ; out:
 52+  80C5                              ; HL - screen address
 53+  80C5                              ; A - scroll offset
 54+  80C5
 55+  80C5 26 00                        ld  h, 0
 56+  80C7 68                           ld  l, b            ; hl = row
 57+  80C8 29                           add hl, hl          ; hl = row number * 2
 58+  80C9 11 28 82                     ld  de, screen_map  ; de = screen map
 59+  80CC 19                           add hl, de          ; de = screen_map + (row * 2)
 60+  80CD 7E                           ld  a, (hl)         ; ld hl, (hl)
 61+  80CE 23                           inc hl
 62+  80CF 66                           ld  h, (hl)
 63+  80D0 6F                           ld  l, a            ; hl = address of first pixel in screen map
 64+  80D1
 65+  80D1 16 00                        ld  d, 0
 66+  80D3 79                           ld  a, c
 67+  80D4 0F                           rrca
 68+  80D5 0F                           rrca
 69+  80D6 0F                           rrca
 70+  80D7 E6 1F                        and 0b00011111
 71+  80D9 5F                           ld e, a             ; de = X (character based)
 72+  80DA 19                           add hl, de          ; hl = screen addr + 32
 73+  80DB 79                           ld a, c
 74+  80DC E6 07                        and 7
 75+  80DE C9                           ret
 76+  80DF
 77+  80DF
 78+  80DF                              ; kills hl, bc, de
 79+  80DF 79           sprite_1ch:     ld a, c
 80+  80E0 81                           add a, c
 81+  80E1 81                           add a, c
 82+  80E2 32 E6 80                     ld (again+1), a
 83+  80E5 18 FE        again:          jr $
 84+  80E7                              ; jump table to unwrapped implementations
 85+  80E7 C3 FF 80                     jp s1_0 ; unused
 86+  80EA C3 15 81                     jp s1_1
 87+  80ED C3 3B 81                     jp s1_2
 88+  80F0 C3 62 81                     jp s1_3
 89+  80F3 C3 8A 81                     jp s1_4
 90+  80F6 C3 B3 81                     jp s1_5
 91+  80F9 C3 DB 81                     jp s1_6
 92+  80FC C3 02 82                     jp s1_7
 93+  80FF
 94+  80FF              s1_0:
 95+  80FF 7E                           ld a, (hl)
 96+  8100 12                           ld (de), a
 97+  8101
 98+  8101                              LineInc_DE
 98+  8101             >
 98+  8101             >                ; move down a pixel line
 98+  8101             >                ; H 0-1-0-y7-y6-y2-y1-y0 l y5-y4-y3-x4-x3-x2-x1-x0
 98+  8101             >
 98+  8101 14          >                inc d
 98+  8102 7A          >                ld a, d
 98+  8103 E6 07       >                and 7
 98+  8105 20 0A       >                jr nz, .q
 98+  8107 7B          >                ld a, e
 98+  8108 C6 20       >                add a, 32
 98+  810A 5F          >                ld e, a
 98+  810B 38 04       >                jr c, .q
 98+  810D 7A          >                ld a, d
 98+  810E D6 08       >                sub 8
 98+  8110 57          >                ld d, a
 98+  8111             >.q:
 98+  8111             >
 99+  8111
100+  8111 23                           inc hl
101+  8112 10 EB                        djnz s1_0
102+  8114 C9                           ret
103+  8115
104+  8115 7E           s1_1:           ld a, (hl)
105+  8116 0F                           rrca
106+  8117 4F                           ld c, a
107+  8118 E6 7F                        and 0b01111111
108+  811A EB                           ex hl, de
109+  811B B6                           or (hl)
110+  811C EB                           ex hl, de
111+  811D 12                           ld (de), a
112+  811E
113+  811E 13                           inc de
114+  811F
115+  811F 79                           ld a, c
116+  8120 E6 80                        and 0b10000000
117+  8122 EB                           ex hl, de
118+  8123 B6                           or (hl)
119+  8124 EB                           ex hl, de
120+  8125 12                           ld (de), a
121+  8126
122+  8126 1B                           dec de
123+  8127
124+  8127                              LineInc_DE
124+  8127             >
124+  8127             >                ; move down a pixel line
124+  8127             >                ; H 0-1-0-y7-y6-y2-y1-y0 l y5-y4-y3-x4-x3-x2-x1-x0
124+  8127             >
124+  8127 14          >                inc d
124+  8128 7A          >                ld a, d
124+  8129 E6 07       >                and 7
124+  812B 20 0A       >                jr nz, .q
124+  812D 7B          >                ld a, e
124+  812E C6 20       >                add a, 32
124+  8130 5F          >                ld e, a
124+  8131 38 04       >                jr c, .q
124+  8133 7A          >                ld a, d
124+  8134 D6 08       >                sub 8
124+  8136 57          >                ld d, a
124+  8137             >.q:
124+  8137             >
125+  8137 23                           inc hl
126+  8138
127+  8138 10 DB                        djnz s1_1
128+  813A C9                           ret
129+  813B
130+  813B 7E           s1_2:           ld a, (hl)
131+  813C 0F                           rrca
132+  813D 0F                           rrca
133+  813E 4F                           ld c, a
134+  813F E6 3F                        and 0b00111111
135+  8141 EB                           ex hl, de
136+  8142 B6                           or (hl)
137+  8143 EB                           ex hl, de
138+  8144 12                           ld (de), a
139+  8145
140+  8145 13                           inc de
141+  8146
142+  8146 79                           ld a, c
143+  8147 E6 C0                        and 0b11000000
144+  8149 EB                           ex hl, de
145+  814A B6                           or (hl)
146+  814B EB                           ex hl, de
147+  814C 12                           ld (de), a
148+  814D
149+  814D 1B                           dec de
150+  814E
151+  814E                              LineInc_DE
151+  814E             >
151+  814E             >                ; move down a pixel line
151+  814E             >                ; H 0-1-0-y7-y6-y2-y1-y0 l y5-y4-y3-x4-x3-x2-x1-x0
151+  814E             >
151+  814E 14          >                inc d
151+  814F 7A          >                ld a, d
151+  8150 E6 07       >                and 7
151+  8152 20 0A       >                jr nz, .q
151+  8154 7B          >                ld a, e
151+  8155 C6 20       >                add a, 32
151+  8157 5F          >                ld e, a
151+  8158 38 04       >                jr c, .q
151+  815A 7A          >                ld a, d
151+  815B D6 08       >                sub 8
151+  815D 57          >                ld d, a
151+  815E             >.q:
151+  815E             >
152+  815E 23                           inc hl
153+  815F
154+  815F 10 DA                        djnz s1_2
155+  8161 C9                           ret
156+  8162
157+  8162 7E           s1_3:           ld a, (hl)
158+  8163 0F                           rrca
159+  8164 0F                           rrca
160+  8165 0F                           rrca
161+  8166 4F                           ld c, a
162+  8167 E6 1F                        and 0b00011111
163+  8169 EB                           ex hl, de
164+  816A B6                           or (hl)
165+  816B EB                           ex hl, de
166+  816C 12                           ld (de), a
167+  816D
168+  816D 13                           inc de
169+  816E
170+  816E 79                           ld a, c
171+  816F E6 E0                        and 0b11100000
172+  8171 EB                           ex hl, de
173+  8172 B6                           or (hl)
174+  8173 EB                           ex hl, de
175+  8174 12                           ld (de), a
176+  8175
177+  8175 1B                           dec de
178+  8176
179+  8176                              LineInc_DE
179+  8176             >
179+  8176             >                ; move down a pixel line
179+  8176             >                ; H 0-1-0-y7-y6-y2-y1-y0 l y5-y4-y3-x4-x3-x2-x1-x0
179+  8176             >
179+  8176 14          >                inc d
179+  8177 7A          >                ld a, d
179+  8178 E6 07       >                and 7
179+  817A 20 0A       >                jr nz, .q
179+  817C 7B          >                ld a, e
179+  817D C6 20       >                add a, 32
179+  817F 5F          >                ld e, a
179+  8180 38 04       >                jr c, .q
179+  8182 7A          >                ld a, d
179+  8183 D6 08       >                sub 8
179+  8185 57          >                ld d, a
179+  8186             >.q:
179+  8186             >
180+  8186 23                           inc hl
181+  8187
182+  8187 10 D9                        djnz s1_3
183+  8189 C9                           ret
184+  818A
185+  818A 7E           s1_4:           ld a, (hl)
186+  818B 0F                           rrca
187+  818C 0F                           rrca
188+  818D 0F                           rrca
189+  818E 0F                           rrca
190+  818F 4F                           ld c, a
191+  8190 E6 0F                        and 0b00001111
192+  8192 EB                           ex hl, de
193+  8193 B6                           or (hl)
194+  8194 EB                           ex hl, de
195+  8195 12                           ld (de), a
196+  8196
197+  8196 13                           inc de
198+  8197
199+  8197 79                           ld a, c
200+  8198 E6 F0                        and 0b11110000
201+  819A EB                           ex hl, de
202+  819B B6                           or (hl)
203+  819C EB                           ex hl, de
204+  819D 12                           ld (de), a
205+  819E
206+  819E 1B                           dec de
207+  819F
208+  819F                              LineInc_DE
208+  819F             >
208+  819F             >                ; move down a pixel line
208+  819F             >                ; H 0-1-0-y7-y6-y2-y1-y0 l y5-y4-y3-x4-x3-x2-x1-x0
208+  819F             >
208+  819F 14          >                inc d
208+  81A0 7A          >                ld a, d
208+  81A1 E6 07       >                and 7
208+  81A3 20 0A       >                jr nz, .q
208+  81A5 7B          >                ld a, e
208+  81A6 C6 20       >                add a, 32
208+  81A8 5F          >                ld e, a
208+  81A9 38 04       >                jr c, .q
208+  81AB 7A          >                ld a, d
208+  81AC D6 08       >                sub 8
208+  81AE 57          >                ld d, a
208+  81AF             >.q:
208+  81AF             >
209+  81AF 23                           inc hl
210+  81B0
211+  81B0 10 D8                        djnz s1_4
212+  81B2 C9                           ret
213+  81B3
214+  81B3
215+  81B3 7E           s1_5:           ld a, (hl)
216+  81B4 07                           rlca
217+  81B5 07                           rlca
218+  81B6 07                           rlca
219+  81B7 4F                           ld c, a
220+  81B8 E6 07                        and 0b00000111
221+  81BA EB                           ex hl, de
222+  81BB B6                           or (hl)
223+  81BC EB                           ex hl, de
224+  81BD 12                           ld (de), a
225+  81BE
226+  81BE 13                           inc de
227+  81BF
228+  81BF 79                           ld a, c
229+  81C0 E6 F8                        and 0b11111000
230+  81C2 EB                           ex hl, de
231+  81C3 B6                           or (hl)
232+  81C4 EB                           ex hl, de
233+  81C5 12                           ld (de), a
234+  81C6
235+  81C6 1B                           dec de
236+  81C7
237+  81C7                              LineInc_DE
237+  81C7             >
237+  81C7             >                ; move down a pixel line
237+  81C7             >                ; H 0-1-0-y7-y6-y2-y1-y0 l y5-y4-y3-x4-x3-x2-x1-x0
237+  81C7             >
237+  81C7 14          >                inc d
237+  81C8 7A          >                ld a, d
237+  81C9 E6 07       >                and 7
237+  81CB 20 0A       >                jr nz, .q
237+  81CD 7B          >                ld a, e
237+  81CE C6 20       >                add a, 32
237+  81D0 5F          >                ld e, a
237+  81D1 38 04       >                jr c, .q
237+  81D3 7A          >                ld a, d
237+  81D4 D6 08       >                sub 8
237+  81D6 57          >                ld d, a
237+  81D7             >.q:
237+  81D7             >
238+  81D7 23                           inc hl
239+  81D8
240+  81D8 10 D9                        djnz s1_5
241+  81DA C9                           ret
242+  81DB
243+  81DB 7E           s1_6:           ld a, (hl)
244+  81DC 07                           rlca
245+  81DD 07                           rlca
246+  81DE 4F                           ld c, a
247+  81DF E6 03                        and 0b00000011
248+  81E1 EB                           ex hl, de
249+  81E2 B6                           or (hl)
250+  81E3 EB                           ex hl, de
251+  81E4 12                           ld (de), a
252+  81E5
253+  81E5 13                           inc de
254+  81E6
255+  81E6 79                           ld a, c
256+  81E7 E6 FC                        and 0b11111100
257+  81E9 EB                           ex hl, de
258+  81EA B6                           or (hl)
259+  81EB EB                           ex hl, de
260+  81EC 12                           ld (de), a
261+  81ED
262+  81ED 1B                           dec de
263+  81EE
264+  81EE                              LineInc_DE
264+  81EE             >
264+  81EE             >                ; move down a pixel line
264+  81EE             >                ; H 0-1-0-y7-y6-y2-y1-y0 l y5-y4-y3-x4-x3-x2-x1-x0
264+  81EE             >
264+  81EE 14          >                inc d
264+  81EF 7A          >                ld a, d
264+  81F0 E6 07       >                and 7
264+  81F2 20 0A       >                jr nz, .q
264+  81F4 7B          >                ld a, e
264+  81F5 C6 20       >                add a, 32
264+  81F7 5F          >                ld e, a
264+  81F8 38 04       >                jr c, .q
264+  81FA 7A          >                ld a, d
264+  81FB D6 08       >                sub 8
264+  81FD 57          >                ld d, a
264+  81FE             >.q:
264+  81FE             >
265+  81FE 23                           inc hl
266+  81FF
267+  81FF 10 DA                        djnz s1_6
268+  8201 C9                           ret
269+  8202
270+  8202 7E           s1_7:           ld a, (hl)
271+  8203 07                           rlca
272+  8204 4F                           ld c, a
273+  8205 E6 01                        and 0b00000001
274+  8207 EB                           ex hl, de
275+  8208 B6                           or (hl)
276+  8209 EB                           ex hl, de
277+  820A 12                           ld (de), a
278+  820B
279+  820B 13                           inc de
280+  820C
281+  820C 79                           ld a, c
282+  820D E6 FE                        and 0b11111110
283+  820F EB                           ex hl, de
284+  8210 B6                           or (hl)
285+  8211 EB                           ex hl, de
286+  8212 12                           ld (de), a
287+  8213
288+  8213 1B                           dec de
289+  8214
290+  8214                              LineInc_DE
290+  8214             >
290+  8214             >                ; move down a pixel line
290+  8214             >                ; H 0-1-0-y7-y6-y2-y1-y0 l y5-y4-y3-x4-x3-x2-x1-x0
290+  8214             >
290+  8214 14          >                inc d
290+  8215 7A          >                ld a, d
290+  8216 E6 07       >                and 7
290+  8218 20 0A       >                jr nz, .q
290+  821A 7B          >                ld a, e
290+  821B C6 20       >                add a, 32
290+  821D 5F          >                ld e, a
290+  821E 38 04       >                jr c, .q
290+  8220 7A          >                ld a, d
290+  8221 D6 08       >                sub 8
290+  8223 57          >                ld d, a
290+  8224             >.q:
290+  8224             >
291+  8224 23                           inc hl
292+  8225
293+  8225 10 DB                        djnz s1_7
294+  8227 C9                           ret
295+  8228
296+  8228              screen_map:
297+  8228 00 40 00 41                  dw 4000h, 4100h, 4200h, 4300h
297+  822C 00 42 00 43
298+  8230 00 44 00 45                  dw 4400h, 4500h, 4600h, 4700h
298+  8234 00 46 00 47
299+  8238 20 40 20 41                  dw 4020h, 4120h, 4220h, 4320h
299+  823C 20 42 20 43
300+  8240 20 44 20 45                  dw 4420h, 4520h, 4620h, 4720h
300+  8244 20 46 20 47
301+  8248 40 40 40 41                  dw 4040h, 4140h, 4240h, 4340h
301+  824C 40 42 40 43
302+  8250 40 44 40 45                  dw 4440h, 4540h, 4640h, 4740h
302+  8254 40 46 40 47
303+  8258 60 40 60 41                  dw 4060h, 4160h, 4260h, 4360h
303+  825C 60 42 60 43
304+  8260 60 44 60 45                  dw 4460h, 4560h, 4660h, 4760h
304+  8264 60 46 60 47
305+  8268 80 40 80 41                  dw 4080h, 4180h, 4280h, 4380h
305+  826C 80 42 80 43
306+  8270 80 44 80 45                  dw 4480h, 4580h, 4680h, 4780h
306+  8274 80 46 80 47
307+  8278 A0 40 A0 41                  dw 40A0h, 41A0h, 42A0h, 43A0h
307+  827C A0 42 A0 43
308+  8280 A0 44 A0 45                  dw 44A0h, 45A0h, 46A0h, 47A0h
308+  8284 A0 46 A0 47
309+  8288 C0 40 C0 41                  dw 40C0h, 41C0h, 42C0h, 43C0h
309+  828C C0 42 C0 43
310+  8290 C0 44 C0 45                  dw 44C0h, 45C0h, 46C0h, 47C0h
310+  8294 C0 46 C0 47
311+  8298 E0 40 E0 41                  dw 40E0h, 41E0h, 42E0h, 43E0h
311+  829C E0 42 E0 43
312+  82A0 E0 44 E0 45                  dw 44E0h, 45E0h, 46E0h, 47E0h
312+  82A4 E0 46 E0 47
313+  82A8 00 48 00 49                  dw 4800h, 4900h, 4A00h, 4B00h
313+  82AC 00 4A 00 4B
314+  82B0 00 4C 00 4D                  dw 4C00h, 4D00h, 4E00h, 4F00h
314+  82B4 00 4E 00 4F
315+  82B8 20 48 20 49                  dw 4820h, 4920h, 4A20h, 4B20h
315+  82BC 20 4A 20 4B
316+  82C0 20 4C 20 4D                  dw 4C20h, 4D20h, 4E20h, 4F20h
316+  82C4 20 4E 20 4F
317+  82C8 40 48 40 49                  dw 4840h, 4940h, 4A40h, 4B40h
317+  82CC 40 4A 40 4B
318+  82D0 40 4C 40 4D                  dw 4C40h, 4D40h, 4E40h, 4F40h
318+  82D4 40 4E 40 4F
319+  82D8 60 48 60 49                  dw 4860h, 4960h, 4A60h, 4B60h
319+  82DC 60 4A 60 4B
320+  82E0 60 4C 60 4D                  dw 4C60h, 4D60h, 4E60h, 4F60h
320+  82E4 60 4E 60 4F
321+  82E8 80 48 80 49                  dw 4880h, 4980h, 4A80h, 4B80h
321+  82EC 80 4A 80 4B
322+  82F0 80 4C 80 4D                  dw 4C80h, 4D80h, 4E80h, 4F80h
322+  82F4 80 4E 80 4F
323+  82F8 A0 48 A0 49                  dw 48A0h, 49A0h, 4AA0h, 4BA0h
323+  82FC A0 4A A0 4B
324+  8300 A0 4C A0 4D                  dw 4CA0h, 4DA0h, 4EA0h, 4FA0h
324+  8304 A0 4E A0 4F
325+  8308 C0 48 C0 49                  dw 48C0h, 49C0h, 4AC0h, 4BC0h
325+  830C C0 4A C0 4B
326+  8310 C0 4C C0 4D                  dw 4CC0h, 4DC0h, 4EC0h, 4FC0h
326+  8314 C0 4E C0 4F
327+  8318 E0 48 E0 49                  dw 48E0h, 49E0h, 4AE0h, 4BE0h
327+  831C E0 4A E0 4B
328+  8320 E0 4C E0 4D                  dw 4CE0h, 4DE0h, 4EE0h, 4FE0h
328+  8324 E0 4E E0 4F
329+  8328 00 50 00 51                  dw 5000h, 5100h, 5200h, 5300h
329+  832C 00 52 00 53
330+  8330 00 54 00 55                  dw 5400h, 5500h, 5600h, 5700h
330+  8334 00 56 00 57
331+  8338 20 50 20 51                  dw 5020h, 5120h, 5220h, 5320h
331+  833C 20 52 20 53
332+  8340 20 54 20 55                  dw 5420h, 5520h, 5620h, 5720h
332+  8344 20 56 20 57
333+  8348 40 50 40 51                  dw 5040h, 5140h, 5240h, 5340h
333+  834C 40 52 40 53
334+  8350 40 54 40 55                  dw 5440h, 5540h, 5640h, 5740h
334+  8354 40 56 40 57
335+  8358 60 50 60 51                  dw 5060h, 5160h, 5260h, 5360h
335+  835C 60 52 60 53
336+  8360 60 54 60 55                  dw 5460h, 5560h, 5660h, 5760h
336+  8364 60 56 60 57
337+  8368 80 50 80 51                  dw 5080h, 5180h, 5280h, 5380h
337+  836C 80 52 80 53
338+  8370 80 54 80 55                  dw 5480h, 5580h, 5680h, 5780h
338+  8374 80 56 80 57
339+  8378 A0 50 A0 51                  dw 50A0h, 51A0h, 52A0h, 53A0h
339+  837C A0 52 A0 53
340+  8380 A0 54 A0 55                  dw 54A0h, 55A0h, 56A0h, 57A0h
340+  8384 A0 56 A0 57
341+  8388 C0 50 C0 51                  dw 50C0h, 51C0h, 52C0h, 53C0h
341+  838C C0 52 C0 53
342+  8390 C0 54 C0 55                  dw 54C0h, 55C0h, 56C0h, 57C0h
342+  8394 C0 56 C0 57
343+  8398 E0 50 E0 51                  dw 50E0h, 51E0h, 52E0h, 53E0h
343+  839C E0 52 E0 53
344+  83A0 E0 54 E0 55                  dw 54E0h, 55E0h, 56E0h, 57E0h
344+  83A4 E0 56 E0 57
345+  83A8
346+  83A8              ; vim: set sw=16 ts=16 :
347+  83A8
# file closed: src/sprites.asm
 95   83A8                              include "keyboard.asm"
# file opened: src/keyboard.asm
  1+  83A8                              module keyboard
  2+  83A8
  3+  83A8              Read:
  4+  83A8 16 00                        ld d, 0
  5+  83AA 01 FE FF                     ld bc, 0xfffe
  6+  83AD
  7+  83AD 21 C9 83                     ld hl, keymap
  8+  83B0 7E           loop:           ld a, (hl)
  9+  83B1 23                           inc hl
 10+  83B2 A7                           and a
 11+  83B3 28 0D                        jr z, done
 12+  83B5
 13+  83B5 47                           ld b, a
 14+  83B6 ED 78                        in a, (c) ; that's port BC actually
 15+  83B8
 16+  83B8 A6                           and (hl) ; 0 - pressed
 17+  83B9 23                           inc hl
 18+  83BA 20 03                        jr nz, no_press
 19+  83BC
 20+  83BC                              ; key pressed
 21+  83BC 7A                           ld a, d
 22+  83BD B6                           or (hl)
 23+  83BE 57                           ld d, a
 24+  83BF
 25+  83BF 23           no_press:       inc hl
 26+  83C0 18 EE                        jr loop
 27+  83C2
 28+  83C2 7A           done:           ld a, d
 29+  83C3 32 C7 83                     ld (movement), a
 30+  83C6 C9                           ret
 31+  83C7
 32+  83C7
 33+  83C7
 34+  83C7
 35+  83C7
 36+  83C7
 37+  83C7 00           movement db 0
 38+  83C8 00           fire     db 0
 39+  83C9
 40+  83C9              BIT_UP    equ 0
 41+  83C9              BIT_LEFT  equ 1
 42+  83C9              BIT_DOWN  equ 2
 43+  83C9              BIT_RIGHT equ 3
 44+  83C9
 45+  83C9
 46+  83C9              keymap
 47+  83C9 FB 02 01                     db 0xfb, 0b00000010, (1 << BIT_UP) ; W
 48+  83CC FD 01 02                     db 0xfd, 0b00000001, (1 << BIT_LEFT) ; A
 49+  83CF FD 02 04                     db 0xfd, 0b00000010, (1 << BIT_DOWN) ; S
 50+  83D2 FD 04 08                     db 0xfd, 0b00000100, (1 << BIT_RIGHT) ; D
 51+  83D5 00                           db 0
 52+  83D6
 53+  83D6                              endmodule
 54+  83D6
# file closed: src/keyboard.asm
 96   83D6
 97   83D6
 98   83D6
 99   83D6                              ; do not put anything after this line
100   83D6                              ; ----------------------------
101   83D6                              include "im2.asm"
# file opened: src/im2.asm
  1+  83D6              im2_table_base equ 0xd000
  2+  83D6
  3+  83D6                              module im2
  4+  83D6
  5+  83D6              Setup:          ; DE - handler routine
  6+  83D6 7B                           ld a, e
  7+  83D7 32 D2 D1                     ld (smc + 1), a
  8+  83DA 7A                           ld a, d
  9+  83DB 32 D3 D1                     ld (smc + 2), a
 10+  83DE
 11+  83DE F3                           di
 12+  83DF 21 00 D0                     ld hl, im2_table_base
 13+  83E2 06 81                        ld b, 129
 14+  83E4
 15+  83E4 7C                           ld a, h
 16+  83E5 ED 47                        ld i, a ; interrupt register hi
 17+  83E7
 18+  83E7 36 D1        .loop           ld (hl), 0xd1
 19+  83E9 23                           inc hl
 20+  83EA 36 D1                        ld (hl), 0xd1
 21+  83EC 23                           inc hl
 22+  83ED 10 F8                        djnz .loop
 23+  83EF
 24+  83EF ED 5E                        im 2
 25+  83F1 FB                           ei
 26+  83F2 C9                           ret
 27+  83F3
 28+  83F3
 29+  83F3                              ; interrupt table
 30+  83F3                              org im2_table_base
 31+  D000 00 00 00...                  defs 256
 32+  D100
 33+  D100                              org 0xd1d1
 34+  D1D1 C3 00 00     smc:            jp $0
 35+  D1D4
 36+  D1D4                              endmodule
 37+  D1D4
# file closed: src/im2.asm
102   D1D4
103   D1D4              	savesna "isaac.sna", Start
104   D1D4
# file closed: src/main.asm
